<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EagleReach</title>
  <link rel="icon" href="data:," />
  <!-- Tailwind (cdn) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white rounded-xl shadow-md p-4 border border-slate-100; }
    .btn  { @apply px-3 py-2 rounded-md text-sm font-medium; }
    .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
    .link { @apply text-blue-600 hover:underline; }
    .pill { @apply inline-block text-xs px-2 py-0.5 rounded bg-slate-100; }
    .shadow-soft { box-shadow: 0 10px 20px rgba(0,0,0,.05), 0 3px 6px rgba(0,0,0,.08); }
    .navlink { @apply text-slate-100/90 hover:text-white; }
    .kbd { @apply px-1.5 py-0.5 rounded bg-slate-100 border border-slate-300 text-[11px]; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <!-- Top bar -->
  <header class="bg-[#0b2c52] text-white sticky top-0 z-40 shadow-soft">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-4">
      <div class="flex items-center gap-2 text-xl font-semibold">
        <span class="text-2xl">ü¶Ö</span>
        <span>EagleReach</span>
        <span class="ml-2 text-sm opacity-80 hidden sm:inline">‚ÄúA nation, as a society, forms a moral person, and every member of it is personally responsible for his society.‚Äù ‚Äî Thomas Jefferson</span>
      </div>
      <nav class="ml-auto hidden sm:flex items-center gap-6 text-sm">
        <!-- Hash links so modals work everywhere + add deep links -->
        <a href="#about"    class="navlink">About</a>
        <a href="#founder"  class="navlink">Founder</a>
        <a href="#contact"  class="navlink">Contact</a>
        <a href="#feedback" class="navlink">Feedback</a>
      </nav>
    </div>
  </header>

  <!-- Search strip -->
  <section class="max-w-6xl mx-auto px-4 pt-6">
    <p class="text-sm text-slate-500 mb-2">Enter your ZIP code to see representatives, voter info, weather, city updates, traffic, and elections.</p>
    <div class="flex flex-wrap items-center gap-2">
      <input id="zipInput" class="w-52 sm:w-64 rounded-md border px-3 py-2" placeholder="ZIP (e.g., 62704)" inputmode="numeric" maxlength="10" />
      <button id="useLoc" class="btn border bg-white hover:bg-slate-50">Use my location</button>
      <button id="searchBtn" class="btn btn-primary">Search</button>
      <button id="shareBtn" class="btn border bg-white hover:bg-slate-50">Copy Share Link</button>
      <button id="clearBtn" class="btn border bg-white hover:bg-slate-50">Clear history</button>
      <span id="status" class="text-sm text-slate-500 ml-2"></span>
    </div>
    <div id="historyRow" class="mt-2 text-sm text-slate-600"></div>
  </section>

  <!-- Content grid -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid gap-4 md:grid-cols-2">
    <section class="card">
      <div class="flex items-center justify-between mb-2">
        <h2 class="font-semibold">Elected Representatives</h2>
        <div class="flex gap-2">
          <button id="copyEmailsBtn" class="pill">Copy Emails</button>
          <button id="genEmailBtn" class="pill">Generate Email</button>
        </div>
      </div>
      <div id="officialsBox" class="space-y-3 text-sm">
        <div class="text-slate-500">Enter a ZIP to load officials‚Ä¶</div>
      </div>
      <div class="mt-3 text-xs text-slate-500">Sources: GovTrack (Congress), Wikidata (Mayor), FCC, Zippopotam.</div>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-2">Weather (7‚Äëday)</h2>
      <div id="weatherBox" class="text-sm text-slate-600">Enter a ZIP to load weather‚Ä¶</div>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-2">Voter Info & Education</h2>
      <ul id="voterBox" class="list-disc ml-5 text-sm space-y-1">
        <li><a id="howToVote" class="link" href="https://www.usa.gov/how-to-vote" target="_blank">How to vote (USA.gov)</a></li>
        <li><a id="regToVote" class="link" href="https://www.usa.gov/register-to-vote" target="_blank">Register to vote</a></li>
        <li><a id="findElectionOffice" class="link" href="https://www.nass.org/can-I-vote" target="_blank">Find your Election Office</a></li>
      </ul>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-2">City updates</h2>
      <div id="cityBox" class="text-sm text-slate-600">Enter a ZIP to load updates‚Ä¶</div>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-2">News</h2>
      <div class="flex gap-2 mb-2">
        <button id="localNewsBtn" class="btn btn-primary">Open Local News</button>
        <button id="worldNewsBtn" class="btn border bg-white hover:bg-slate-50">World News</button>
      </div>
      <div class="text-xs text-slate-500">Opens news in a new tab.</div>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-2">Upcoming Elections</h2>
      <div id="elexBox" class="text-sm text-slate-600">Next Federal: November 3, 2025<br/><span class="text-xs">State/Local specific dates coming from open data.</span></div>
    </section>

    <section class="card">
      <h2 class="font-semibold mb-2">Traffic</h2>
      <p class="text-sm text-slate-600">Open live traffic for your area in Google Maps.</p>
      <button id="trafficBtn" class="btn border bg-white hover:bg-slate-50 mt-2">Open Traffic Map</button>
    </section>

    <section class="md:col-span-2 card">
      <h2 class="font-semibold mb-2">Raise a Concern</h2>
      <p class="text-sm text-slate-600 mb-2">Report city issues (311), contact your city hall, or write to your representatives.</p>
      <div class="flex flex-wrap gap-2">
        <a id="issuePothole" class="pill link" href="#">Potholes</a>
        <a id="issueTrash"   class="pill link" href="#">Trash</a>
        <a id="issueLights"  class="pill link" href="#">Street lights</a>
      </div>
    </section>

    <section class="card md:col-span-2">
      <h2 class="font-semibold mb-3">Emergency</h2>
      <div class="grid sm:grid-cols-3 md:grid-cols-6 gap-3">
        <a class="btn bg-red-600 text-white text-center" href="tel:911">911 ‚Äî Emergency</a>
        <a class="btn bg-fuchsia-600 text-white text-center" href="tel:988">988 ‚Äî Suicide &amp; Crisis</a>
        <a class="btn bg-green-600 text-white text-center" href="tel:211">211 ‚Äî Community Services</a>
        <a class="btn bg-sky-600 text-white text-center" href="tel:311">311 ‚Äî City Services</a>
        <a class="btn bg-amber-600 text-white text-center" href="tel:811">811 ‚Äî Before You Dig</a>
        <a class="btn bg-orange-600 text-white text-center" href="tel:18002221222">Poison Control</a>
      </div>
      <p class="text-xs text-slate-500 mt-2">Tap a number to call.</p>
    </section>
  </main>

  <!-- Modal -->
  <div id="modalBg" class="fixed inset-0 bg-black/40 hidden z-50">
    <div class="min-h-full flex items-start justify-center p-4">
      <div id="modalBox" class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mt-10">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <h3 id="modalTitle" class="font-semibold">Title</h3>
          <button id="modalClose" class="text-slate-500 hover:text-slate-700 text-xl" aria-label="Close">‚úï</button>
        </div>
        <div id="modalBody" class="p-4 text-sm leading-6"></div>
      </div>
    </div>
  </div>

  <footer class="max-w-6xl mx-auto px-4 pb-10 text-xs text-slate-500">
    ¬© 2025 EagleReach. Built open‚Äësource.
  </footer>

  <script>
  // ---------------- CONFIG ----------------
  const BACKEND_BASE = "https://eaglereach-1.onrender.com"; // change if yours differs

  // --------------- UTILITIES --------------
  const $ = s => document.querySelector(s);
  const statusEl = $("#status");
  const zipInput = $("#zipInput");
  const historyRow = $("#historyRow");

  function setStatus(msg){ statusEl.textContent = msg || ""; }
  function validZip(v){ return /^\d{5}(-\d{4})?$/.test((v||"").trim()); }

  function saveZipHistory(zip){
    if(!validZip(zip)) return;
    const key="er:zips";
    let arr = JSON.parse(localStorage.getItem(key)||"[]");
    arr = [zip, ...arr.filter(x=>x!==zip)].slice(0,5);
    localStorage.setItem(key, JSON.stringify(arr));
    renderHistory();
  }

  function renderHistory(){
    const key="er:zips";
    const arr = JSON.parse(localStorage.getItem(key)||"[]");
    historyRow.innerHTML = arr.length
      ? `Recent: ${arr.map(z=>`<button class="pill mr-1" onclick="loadZip('${z}')">${z}</button>`).join("")}`
      : "";
  }

  function copyShare(){
    const url = new URL(location.href);
    const z = zipInput.value.trim();
    if(validZip(z)){ url.searchParams.set("zip", z); }
    navigator.clipboard.writeText(url.toString()).then(()=>setStatus("Link copied."));
  }

  function clearHistory(){
    localStorage.removeItem("er:zips");
    renderHistory();
    zipInput.value = "";
    setStatus("History cleared.");
  }

  // ---- Modal helpers (with hash-aware closing) ----
  function showModal(title, html){
    $("#modalTitle").textContent = title;
    $("#modalBody").innerHTML = html;
    $("#modalBg").classList.remove("hidden");
  }
  function closeModal() {
    $("#modalBg").classList.add("hidden");
  }
  function closeModalAndClearHash(){
    closeModal();
    if (location.hash) history.replaceState(null, '', location.pathname + location.search);
  }
  $("#modalClose").onclick = closeModalAndClearHash;
  $("#modalBg").addEventListener('click', (e)=>{ if(e.target.id==='modalBg') closeModalAndClearHash(); });

  // ---------- Hash router for modals ----------
  function routeModal(hash){
    switch((hash||'').toLowerCase()){
      case '#about':
        showModal("About EagleReach", `
          <p><b>EagleReach</b> is a public, open‚Äësource civic assistant that brings together local
          services in one fast place: representatives, voter education, city updates, weather,
          live traffic, and ready‚Äëto‚Äësend concern templates.</p>
          <ul class="list-disc ml-5 mt-3">
            <li>No logins. No ads. No tracking.</li>
            <li>Open‚Äëdata powered; free for everyone.</li>
            <li>Built to make government simpler and more human.</li>
          </ul>
        `); break;
      case '#founder':
        showModal("Founder", `
          <p><b>Vikesh Sagar Bairam</b> ‚Äî Founder of EagleReach. Tech Evangelist & Business
          Solutions Architect; AI/ML & Data Engineer; DevOps Specialist; Research Professional.</p>
          <p class="mt-2">M.S. in Information Systems & Management (University of Illinois Springfield);
          dual Bachelors in Psychology and Computer Science. Currently at Jabil; previously at Surfaces by Pacific.</p>
        `); break;
      case '#contact':
        showModal("Contact", `
          <div class="space-y-2">
            <div>LinkedIn: <a class="link" target="_blank" href="https://www.linkedin.com/in/vikeshbairam">/in/vikeshbairam</a></div>
            <div>GitHub: <a class="link" target="_blank" href="https://github.com/vikesh2608">@vikesh2608</a></div>
            <div>Email: <a class="link" href="mailto:vikebairam@gmail.com">vikebairam@gmail.com</a></div>
          </div>
        `); break;
      case '#feedback':
        showModal("Feedback", `
          <form id="fbForm" class="space-y-3">
            <div class="flex gap-1 text-xl" id="stars">
              <button type="button" class="star">‚≠ê</button>
              <button type="button" class="star">‚≠ê</button>
              <button type="button" class="star">‚≠ê</button>
              <button type="button" class="star">‚≠ê</button>
              <button type="button" class="star">‚≠ê</button>
            </div>
            <input id="fbName"  class="w-full rounded border px-3 py-2" placeholder="Your name (optional)" />
            <input id="fbEmail" class="w-full rounded border px-3 py-2" placeholder="Your email (optional)" />
            <textarea id="fbText" class="w-full rounded border px-3 py-2" rows="4" placeholder="Your comments"></textarea>
            <button class="btn btn-primary" type="submit">Send</button>
          </form>
          <p class="text-xs text-slate-500 mt-2">Sends via your email app (no server storage).</p>
        `);
        setTimeout(()=>{
          const stars = [...document.querySelectorAll('#stars .star')];
          let rating = 0;
          stars.forEach((btn,idx)=>btn.addEventListener('click', ()=>{
            rating = idx+1;
            stars.forEach((b,i)=> b.textContent = i<rating ? '‚≠ê' : '‚òÜ');
          }));
          document.getElementById('fbForm').addEventListener('submit',(e)=>{
            e.preventDefault();
            const name = document.getElementById('fbName').value.trim();
            const email = document.getElementById('fbEmail').value.trim();
            const text = document.getElementById('fbText').value.trim();
            const body = encodeURIComponent(
              `Rating: ${rating}/5\nName: ${name}\nEmail: ${email}\n\n${text}`
            );
            location.href = `mailto:vikebairam@gmail.com?subject=EagleReach%20Feedback&body=${body}`;
            closeModalAndClearHash();
          });
        }, 0);
        break;
      default: return;
    }
  }
  window.addEventListener('hashchange', ()=>routeModal(location.hash));
  routeModal(location.hash);

  // ------------- DATA FETCHERS -------------
  async function getJSON(url){
    const r = await fetch(url, {headers:{'Accept':'application/json'}});
    if(!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return r.json();
  }

  async function loadZip(zip){
    if(!validZip(zip)) { setStatus("Please enter a valid 5‚Äëdigit US ZIP."); return; }
    zipInput.value = zip;
    setStatus("Loading‚Ä¶");
    saveZipHistory(zip);
    try {
      const [off, wx, city] = await Promise.allSettled([
        getJSON(`${BACKEND_BASE}/officials?zip=${encodeURIComponent(zip)}`),
        getJSON(`${BACKEND_BASE}/weather?zip=${encodeURIComponent(zip)}`),
        getJSON(`${BACKEND_BASE}/city/updates?zip=${encodeURIComponent(zip)}`)
      ]);

      // Officials
      const oBox = $("#officialsBox");
      if(off.status==="fulfilled"){
        const rows = off.value.officials || [];
        oBox.innerHTML = rows.map(r=>`
          <div class="border rounded p-2">
            <div class="font-medium">${r.name} ‚Äî <span class="text-slate-600">${r.office}${r.party?` ‚Äî ${r.party}`:''}</span></div>
            <div class="flex items-center gap-2 mt-1 text-[13px]">
              ${ (r.urls||[]).map(u=>`<a class="link" target="_blank" href="${u}">${new URL(u).hostname.replace('www.','')}</a>`).join(' ‚Ä¢ ') || '' }
              ${ (r.phones||[]).map(p=>`<a class="link" href="tel:${p.replace(/[^0-9]/g,'')}">${p}</a>`).join(' ‚Ä¢ ') || '' }
            </div>
          </div>
        `).join('') || `<div class="text-slate-500">No officials found.</div>`;
      } else {
        oBox.innerHTML = `<div class="text-rose-600">Officials error: ${off.reason.message}</div>`;
      }

      // Weather
      const wBox = $("#weatherBox");
      if(wx.status==="fulfilled"){
        const days = wx.value.days || [];
        wBox.innerHTML = days.map(d=>`
          <div class="flex items-center justify-between border rounded p-2 mb-1">
            <div>${d.date}</div>
            <div class="text-slate-600">${d.summary||''}</div>
            <div class="text-slate-700">${Math.round(d.tmin_c)}¬∞C / ${Math.round(d.tmax_c)}¬∞C ¬∑ ${d.precip_pct}%</div>
          </div>
        `).join('') || `<div class="text-slate-500">No forecast.</div>`;
      } else {
        wBox.innerHTML = `<div class="text-rose-600">Weather error: ${wx.reason.message}</div>`;
      }

      // City updates
      const cBox = $("#cityBox");
      if(city.status==="fulfilled"){
        const items = city.value.items || city.value.updates || [];
        cBox.innerHTML = items.slice(0,8).map(it=>`
          <div class="border rounded p-2 mb-1">
            <div class="font-medium">${it.type||it.title||'Update'}</div>
            <div class="text-slate-600 text-sm">${it.detail||it.description||''}</div>
            ${it.address? `<div class="text-xs text-slate-500 mt-1">${it.address}</div>`:''}
            ${it.map? `<a target="_blank" class="link text-xs" href="${it.map}">Map</a>`:''}
          </div>
        `).join('') || `<div class="text-slate-500">No updates available.</div>`;
      } else {
        cBox.innerHTML = `<div class="text-rose-600">City updates error: ${city.reason.message}</div>`;
      }

      setStatus(`Showing results for ${zip}`);
    } catch (err){
      setStatus(err.message);
    }
  }

  // ------------- UI WIRING --------------
  $("#searchBtn").onclick = ()=> loadZip(zipInput.value.trim());
  $("#shareBtn").onclick  = copyShare;
  $("#clearBtn").onclick  = clearHistory;

  // Use my location ‚Üí reverse geocode via Open‚ÄëMeteo (no key)
  $("#useLoc").onclick = ()=>{
    if(!navigator.geolocation){ setStatus("Geolocation not supported."); return; }
    setStatus("Locating‚Ä¶");
    navigator.geolocation.getCurrentPosition(async pos=>{
      try{
        const {latitude, longitude} = pos.coords;
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&forecast_days=1&timezone=auto`);
        await r.json(); // not used, only to ensure network allowed
        // use your backend helpers to resolve lat/lon to nearest ZIP, or call zippopotam
        const zr = await fetch(`https://api.zippopotam.us/us/${latitude},${longitude}`)
          .catch(()=>null);
        // Fallback: your backend can accept lat/lon route in future; for now, try nearest city ZIP via FCC
        let zip = "";
        if(zr && zr.ok){
          const jj = await zr.json();
          zip = jj?.places?.[0]?.['post code'] || "";
        }
        if(!validZip(zip)){ setStatus("Could not determine ZIP; please type it."); return; }
        loadZip(zip);
      }catch(e){ setStatus("Location lookup failed."); }
    }, err => setStatus(err.message||"Location denied."));
  };

  // Concern templates (mailto to mayor or city 311)
  function mailto(subject, body){
    location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  }
  $("#issuePothole").onclick = e=>{
    e.preventDefault();
    mailto("Pothole report",
      `Hello,\n\nI'd like to report a pothole at [address / nearest cross streets].\n\nDetails:\n- Size/depth: \n- Photo link (if any): \n\nPlease advise next steps. Thank you.`);
  };
  $("#issueTrash").onclick = e=>{
    e.preventDefault();
    mailto("Missed trash pickup",
      `Hello,\n\nTrash/garbage pickup appears to have been missed at [address] on [date].\n\nPlease arrange a pickup or let me know the schedule. Thank you.`);
  };
  $("#issueLights").onclick = e=>{
    e.preventDefault();
    mailto("Street light out",
      `Hello,\n\nA street light is out at [location].\n\nPole number (if visible): \nNearest intersection: \n\nThanks for your help.`);
  };

  // Email helpers on officials
  $("#copyEmailsBtn").onclick = ()=>{
    const emails = [...document.querySelectorAll("#officialsBox a[href^='mailto:']")]
      .map(a=>a.getAttribute('href').replace(/^mailto:/,''));
    if(!emails.length){ setStatus("No emails to copy."); return; }
    navigator.clipboard.writeText(emails.join(", ")).then(()=> setStatus("Emails copied."));
  };
  $("#genEmailBtn").onclick = ()=>{
    const body = `Dear Representative,\n\n[Write your message here]\n\nRegards,\n[Your name]\n[Your address]`;
    location.href = `mailto:?subject=${encodeURIComponent("Constituent message")}&body=${encodeURIComponent(body)}`;
  };

  // News & traffic
  $("#localNewsBtn").onclick = ()=> window.open("https://news.google.com/local", "_blank","noopener");
  $("#worldNewsBtn").onclick = ()=> window.open("https://news.google.com/topstories?hl=en-US&gl=US&ceid=US:en", "_blank","noopener");
  $("#trafficBtn").onclick    = ()=> window.open("https://www.google.com/maps/@?api=1&map_action=map&layer=traffic", "_blank","noopener");

  // Load from URL ?zip=
  (function initFromURL(){
    const p = new URLSearchParams(location.search);
    const z = p.get("zip");
    if(z){ zipInput.value = z; loadZip(z); }
    renderHistory();
  })();
  </script>
</body>
</html>
