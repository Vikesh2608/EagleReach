<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>EagleReach</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f2744" />
  <link rel="apple-touch-icon" href="icons/eagle-192.png" />

  <style>
    :root {
      --brand:#0f2744;       /* header/nav color */
      --card:#ffffff;        /* cards */
      --muted:#6b7280;       /* gray-500 */
      --ring:#e5e7eb;        /* gray-200 */
    }
    .hero-grad {
      background: linear-gradient(180deg, #0f2744 0%, #183a63 55%, #0f2744 100%);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--ring);
      border-radius: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.05);
    }
    .btn {
      display: inline-flex; align-items: center; gap:.5rem;
      background:#2563eb; color:#fff; font-weight:600;
      padding:.55rem .9rem; border-radius:.65rem;
    }
    .btn-secondary { background:#eef2ff; color:#1e40af; }
    .btn-ghost {
      background:#fff; color:#111827; border:1px solid var(--ring);
    }
    .link { color:#2563eb }
    .pill { border-radius:9999px; padding:.25rem .55rem; }
    /* modal */
    .modal {
      position: fixed; inset:0; display:none; place-items:center;
      background: rgba(17,24,39,.55); z-index:50;
    }
    .modal.open { display:grid; }
    .modal-card { background:#fff; width:min(760px, 92vw); border-radius:16px; }
  </style>
</head>

<body class="bg-gray-50 text-gray-900">

  <!-- Header / Nav -->
  <header class="hero-grad text-white">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">ü¶Ö</span>
        <span class="font-semibold text-xl tracking-wide">EagleReach</span>
      </div>

      <nav class="hidden md:flex items-center gap-6 text-sm">
        <button class="hover:opacity-90" data-open="about">About</button>
        <button class="hover:opacity-90" data-open="founder">Founder</button>
        <button class="hover:opacity-90" data-open="contact">Contact</button>
        <button class="hover:opacity-90" data-open="feedback">Feedback</button>
        <button id="installBtn" class="btn-secondary hidden" title="Install app">‚§ì Install</button>
      </nav>
    </div>

    <div class="max-w-6xl mx-auto px-4 pb-4">
      <p class="text-xs md:text-[13px] opacity-90">
        ‚ÄúA nation, as a society, forms a moral person, and every member of it is personally responsible for his society.‚Äù ‚Äî Thomas Jefferson
      </p>
    </div>
  </header>

  <!-- Search controls -->
  <section class="max-w-6xl mx-auto px-4 mt-6">
    <p class="text-sm text-gray-600 mb-2">
      Enter your ZIP code to see representatives, voter info, weather, city updates, traffic, and elections.
    </p>
    <div class="flex flex-wrap items-center gap-3">
      <input id="zipInput" type="text" inputmode="numeric" maxlength="10"
             class="px-3 py-2 rounded-md border border-gray-200 w-[240px] bg-white"
             placeholder="ZIP (e.g., 62704)" />
      <button id="locBtn" class="btn-ghost">Use my location</button>
      <button id="searchBtn" class="btn">Search</button>
      <button id="shareBtn" class="btn-ghost">Copy Share Link</button>
      <button id="clearBtn" class="btn-ghost">Clear history</button>
    </div>
    <div id="zipBadge" class="text-sm text-gray-600 mt-2"></div>
  </section>

  <!-- Content grid -->
  <main class="max-w-6xl mx-auto px-4 mt-6 grid md:grid-cols-2 lg:grid-cols-3 gap-5">

    <!-- Officials -->
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <h2 class="font-semibold text-lg">Elected Representatives</h2>
        <div class="flex gap-2">
          <button id="copyEmailsBtn" class="btn-ghost text-sm">Copy Emails</button>
          <button id="genEmailBtn" class="btn text-sm">Generate Email</button>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-1">
        Sources: GovTrack (Congress), Wikidata (Mayor), FCC, Zippopotam.
      </p>
      <div id="officials" class="space-y-3 mt-3"></div>
    </section>

    <!-- Weather -->
    <section class="card p-4">
      <h2 class="font-semibold text-lg">Weather (7-day)</h2>
      <div id="weather" class="mt-3 text-sm text-gray-700">
        Enter a ZIP to load weather‚Ä¶
      </div>
    </section>

    <!-- Voter Info -->
    <section class="card p-4">
      <h2 class="font-semibold text-lg">Voter Info & Education</h2>
      <ul class="list-disc pl-5 text-sm mt-2">
        <li><a class="link" target="_blank" href="https://www.usa.gov/how-to-vote">How to vote (USA.gov)</a></li>
        <li><a class="link" target="_blank" href="https://www.vote.gov/">Register to vote</a></li>
        <li><a class="link" target="_blank" href="https://www.usa.gov/election-office">Find your Election Office</a></li>
      </ul>
    </section>

    <!-- City updates -->
    <section class="card p-4">
      <h2 class="font-semibold text-lg">City updates</h2>
      <div id="city" class="text-sm mt-3 text-gray-700">
        Enter a ZIP to load updates‚Ä¶
      </div>
    </section>

    <!-- News -->
    <section class="card p-4">
      <h2 class="font-semibold text-lg">News</h2>
      <div class="mt-3 flex gap-3">
        <a id="localNews" class="btn" target="_blank" href="#">Open Local News</a>
        <a id="worldNews" class="btn-ghost" target="_blank" href="https://news.google.com/home">World News</a>
      </div>
      <p class="text-xs text-gray-500 mt-2">Opens news in a new tab.</p>
    </section>

    <!-- Elections -->
    <section class="card p-4">
      <h2 class="font-semibold text-lg">Upcoming Elections</h2>
      <div id="elections" class="text-sm text-gray-700 mt-3">
        Next Federal: <b>November 3, 2025</b><br/>
        State/Local specific dates coming from open data.
      </div>
    </section>

    <!-- Traffic -->
    <section class="card p-4">
      <h2 class="font-semibold text-lg">Traffic</h2>
      <p class="text-sm text-gray-700 mt-2">
        Open live traffic for your area in Google Maps.
      </p>
      <button id="trafficBtn" class="btn-ghost mt-3">Open Traffic Map</button>
    </section>

    <!-- Emergency -->
    <section class="card p-4 lg:col-span-3">
      <h2 class="font-semibold text-lg">Emergency</h2>
      <p class="text-xs text-gray-500 mb-3">Tap a number to call.</p>
      <div class="flex flex-wrap gap-3">
        <a class="btn bg-red-600 hover:bg-red-700" href="tel:911">911 ‚Äî Emergency</a>
        <a class="btn bg-fuchsia-600 hover:bg-fuchsia-700" href="tel:988">988 ‚Äî Suicide &amp; Crisis</a>
        <a class="btn bg-green-600 hover:bg-green-700" href="tel:211">211 ‚Äî Community Services</a>
        <a class="btn bg-sky-700 hover:bg-sky-800" href="tel:311">311 ‚Äî City Services</a>
        <a class="btn bg-amber-700 hover:bg-amber-800" href="tel:811">811 ‚Äî Before You Dig</a>
        <a class="btn bg-orange-600 hover:bg-orange-700" href="tel:18002221222">Poison Control</a>
      </div>
    </section>

    <!-- Raise a concern -->
    <section class="card p-4 lg:col-span-3">
      <h2 class="font-semibold text-lg">Raise a Concern</h2>
      <p class="text-sm text-gray-700 mt-2">
        Report city issues (311), contact your city hall, or write to your representatives.
      </p>
      <div class="mt-3 flex flex-wrap gap-3">
        <a id="concernPotholes" class="btn-ghost" href="#">Potholes</a>
        <a id="concernTrash" class="btn-ghost" href="#">Trash</a>
        <a id="concernLights" class="btn-ghost" href="#">Street lights</a>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="max-w-6xl mx-auto px-4 py-8 text-xs text-gray-500">
    ¬© 2025 EagleReach. Built open‚Äësource.
  </footer>

  <!-- Modals -->
  <!-- About -->
  <div id="aboutModal" class="modal">
    <div class="modal-card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">About EagleReach</h3>
        <button class="text-gray-500" data-close>&times;</button>
      </div>
      <div class="mt-3 text-sm leading-6">
        <p><b>EagleReach</b> is a public, open‚Äësource civic assistant that connects residents with elected officials, voter information, weather, traffic, and local updates‚Äîfast and reliably, without ads or logins.</p>
        <ul class="list-disc pl-5 mt-3">
          <li>One ZIP ‚Üí your officials, emails, and phone numbers.</li>
          <li>7‚Äëday weather, traffic map, and emergency numbers one tap away.</li>
          <li>Voter education: how to vote, register, and find your local office.</li>
          <li>Write‚Äëready templates for potholes, trash, and street‚Äëlight concerns.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Founder -->
  <div id="founderModal" class="modal">
    <div class="modal-card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Founder</h3>
        <button class="text-gray-500" data-close>&times;</button>
      </div>
      <div class="mt-3 text-sm leading-6">
        <p><b>Vikesh Sagar Bairam</b> ‚Äî Founder of EagleReach ‚Ä¢ Tech Evangelist ‚Ä¢ Business Solutions Architect ‚Ä¢ AI/ML &amp; Data Engineer ‚Ä¢ DevOps Specialist ‚Ä¢ Research Professional.</p>
        <p class="mt-2">M.S. in Information Systems &amp; Management (University of Illinois, Springfield). B.S. in Psychology and B.S. in Computer Science. Currently at Jabil; previously at Surfaces by Pacific.</p>
      </div>
    </div>
  </div>

  <!-- Contact -->
  <div id="contactModal" class="modal">
    <div class="modal-card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Contact</h3>
        <button class="text-gray-500" data-close>&times;</button>
      </div>
      <div class="mt-3 text-sm leading-6">
        <p>
          LinkedIn:
          <a class="link" target="_blank"
             href="https://www.linkedin.com/in/LINKEDIN_PROFILE_URL">Vikesh Bairam</a><br/>
          GitHub:
          <a class="link" target="_blank" href="https://github.com/vikesh2608">vikesh2608</a><br/>
          Email:
          <a class="link" href="mailto:vikebairam@gmail.com">vikebairam@gmail.com</a>
        </p>
        <p class="mt-3 text-xs text-gray-500">
          Tip: Copy your exact LinkedIn profile link from LinkedIn ‚Üí Profile ‚Üí More ‚Üí Copy link to profile,
          then replace <code>LINKEDIN_PROFILE_URL</code> above.
        </p>
      </div>
    </div>
  </div>

  <!-- Feedback -->
  <div id="feedbackModal" class="modal">
    <div class="modal-card p-5">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Feedback</h3>
        <button class="text-gray-500" data-close>&times;</button>
      </div>
      <form id="feedbackForm" class="mt-3 grid gap-3 text-sm">
        <div class="grid md:grid-cols-2 gap-3">
          <input id="fbName" class="border border-gray-200 rounded-md px-3 py-2" placeholder="Your name (optional)" />
          <input id="fbEmail" type="email" class="border border-gray-200 rounded-md px-3 py-2" placeholder="Email (optional)" />
        </div>
        <textarea id="fbMsg" rows="4" class="border border-gray-200 rounded-md px-3 py-2"
                  placeholder="Share your thoughts, suggestions, or issues‚Ä¶"></textarea>
        <div class="flex items-center gap-2">
          <span>Rate:</span>
          <div id="stars" class="flex gap-1 text-xl cursor-pointer select-none" aria-label="rating">
            <span data-s="1">‚≠ê</span><span data-s="2">‚≠ê</span><span data-s="3">‚≠ê</span><span data-s="4">‚≠ê</span><span data-s="5">‚≠ê</span>
          </div>
          <span id="starsNote" class="text-xs text-gray-500 ml-2"></span>
        </div>
        <div class="flex justify-end">
          <button class="btn" type="submit">Send</button>
        </div>
        <p id="fbThanks" class="hidden text-green-700 text-sm">Thank you! Your feedback was noted.</p>
      </form>
    </div>
  </div>

  <!-- JS -->
  <script>
    const API = "https://eaglereach-1.onrender.com"; // backend base

    // Elements
    const zipInput = document.getElementById("zipInput");
    const zipBadge = document.getElementById("zipBadge");
    const searchBtn = document.getElementById("searchBtn");
    const locBtn = document.getElementById("locBtn");
    const shareBtn = document.getElementById("shareBtn");
    const clearBtn = document.getElementById("clearBtn");

    const officialsDiv = document.getElementById("officials");
    const weatherDiv  = document.getElementById("weather");
    const cityDiv     = document.getElementById("city");
    const electionsDiv= document.getElementById("elections");

    const localNews = document.getElementById("localNews");
    const worldNews = document.getElementById("worldNews");
    const trafficBtn= document.getElementById("trafficBtn");

    const copyEmailsBtn = document.getElementById("copyEmailsBtn");
    const genEmailBtn   = document.getElementById("genEmailBtn");

    const concernPotholes = document.getElementById("concernPotholes");
    const concernTrash    = document.getElementById("concernTrash");
    const concernLights   = document.getElementById("concernLights");

    // Helpers
    const qs = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function toast(msg){ alert(msg); }

    // Load from URL param if present
    const url = new URL(location.href);
    const zipFromUrl = url.searchParams.get("zip") || "";
    if (zipFromUrl) {
      zipInput.value = zipFromUrl;
      runSearch(zipFromUrl);
    }

    // Copy share link
    shareBtn.addEventListener("click", async () => {
      const z = (zipInput.value || "").trim();
      if (!z) return toast("Enter a ZIP first.");
      const link = `${location.origin}${location.pathname}?zip=${encodeURIComponent(z)}`;
      await navigator.clipboard.writeText(link);
      toast("Share link copied.");
    });

    // Clear history
    clearBtn.addEventListener("click", () => {
      zipInput.value = "";
      zipBadge.textContent = "";
      officialsDiv.innerHTML = "";
      weatherDiv.textContent  = "Enter a ZIP to load weather‚Ä¶";
      cityDiv.textContent     = "Enter a ZIP to load updates‚Ä¶";
      history.replaceState(null,"",location.pathname);
    });

    // Search click
    searchBtn.addEventListener("click", () => {
      const z = (zipInput.value || "").trim();
      if (!z) return toast("Enter a ZIP.");
      runSearch(z);
    });

    // Use my location ‚Üí try to get ZIP server-side (lat/lon‚ÜíZIP)
    locBtn.addEventListener("click", async () => {
      locBtn.disabled = true;
      locBtn.textContent = "Locating‚Ä¶";
      try {
        const pos = await new Promise((res,rej)=>
          navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true, timeout:10000})
        );
        const {latitude, longitude} = pos.coords;
        // Use backend helper (FCC reverse or OpenMeteo reverse) ‚Üí returns {zip, city, state}
        const r = await fetch(`${API}/zipfrom?lat=${latitude}&lon=${longitude}`);
        if (!r.ok) throw new Error("reverse failed");
        const j = await r.json();
        if (!j.zip) throw new Error("no zip");
        zipInput.value = j.zip;
        runSearch(j.zip, j.city, j.state);
      } catch (e) {
        toast("Could not resolve ZIP from your location.");
      } finally {
        locBtn.disabled = false;
        locBtn.textContent = "Use my location";
      }
    });

    // Core: run search by ZIP
    async function runSearch(zip, city=null, state=null){
      zipBadge.textContent = "";
      try {
        // Officials
        const o = await (await fetch(`${API}/officials?zip=${encodeURIComponent(zip)}`)).json();
        const place = o.place || city || "";
        const stAbr = o?.state?.abbr || state || "";
        zipBadge.textContent = `${zip} ‚Äî ${place ? place + ", " : ""}${stAbr || ""}`;

        renderOfficials(o.officials || []);

        // Weather
        const w = await (await fetch(`${API}/weather?zip=${encodeURIComponent(zip)}`)).json();
        renderWeather(w.days || []);

        // City updates (if available)
        try {
          const c = await (await fetch(`${API}/city/updates?zip=${encodeURIComponent(zip)}`)).json();
          renderCity(c.updates || []);
        } catch { cityDiv.textContent = "City updates unavailable."; }

        // Local news link
        localNews.href = `https://news.google.com/search?q=${encodeURIComponent(place||zip)}&hl=en-US&gl=US&ceid=US:en`;

        // Traffic map
        trafficBtn.onclick = () => {
          window.open(`https://www.google.com/maps/@?api=1&map_action=map&layer=traffic&query=${encodeURIComponent(place||zip)}`,"_blank");
        };

        // Concern templates (mailto)
        concernPotholes.href = makeMailto(o.officials, "Pothole concern", "Hello,\n\nI would like to report potholes in my neighborhood.");
        concernTrash.href    = makeMailto(o.officials, "Trash collection issue", "Hello,\n\nTrash collection has been missed in my area.");
        concernLights.href   = makeMailto(o.officials, "Street light is out", "Hello,\n\nA street light is not functioning in my neighborhood.");

        // update URL
        const u = new URL(location.href);
        u.searchParams.set("zip", zip);
        history.replaceState(null, "", u);

      } catch (e) {
        toast("Failed to load data. Please try another ZIP.");
      }
    }

    function renderOfficials(rows){
      officialsDiv.innerHTML = "";
      if (!rows || !rows.length){
        officialsDiv.textContent = "Enter a ZIP to load officials‚Ä¶";
        return;
      }
      rows.forEach(r=>{
        const el = document.createElement("div");
        el.className = "border border-gray-200 rounded-md p-3";
        const url = (r.urls && r.urls[0]) ? r.urls[0] : null;
        const phone = (r.phones && r.phones[0]) ? r.phones[0] : null;
        el.innerHTML = `
          <div class="text-[15px] font-medium">${r.name || "‚Äî"} <span class="text-gray-500">‚Äî ${r.office || ""}</span></div>
          <div class="mt-1 text-sm flex flex-col gap-1">
            ${url ? `<a class="link" target="_blank" href="${url}">${new URL(url).hostname}</a>` : ""}
            ${phone ? `<a class="text-gray-700" href="tel:${phone.replace(/[^0-9]/g,"")}">${phone}</a>` : ""}
          </div>
        `;
        officialsDiv.appendChild(el);
      });

      // copy all emails
      copyEmailsBtn.onclick = () => {
        const emails = rows.flatMap(r => r.emails||[]).join(", ");
        if (!emails) return toast("No emails available.");
        navigator.clipboard.writeText(emails).then(()=>toast("Emails copied."));
      };

      // sample generated email
      genEmailBtn.onclick = () => {
        const to = rows.flatMap(r => r.emails||[]).slice(0,3).join(",");
        const subject = encodeURIComponent("Constituent inquiry");
        const body = encodeURIComponent("Dear Representative,\n\nI'm a constituent in your district and wanted to share a concern‚Ä¶\n\nSincerely,\n");
        location.href = `mailto:${to}?subject=${subject}&body=${body}`;
      };
    }

    function renderWeather(days){
      if (!days.length){ weatherDiv.textContent = "No forecast available."; return; }
      const rows = days.map(d=>{
        const cond = d.cond || d.condition || "";
        const tmax = (d.tmax_c!=null?`${d.tmax_c}¬∞C`:"");
        const tmin = (d.tmin_c!=null?`${d.tmin_c}¬∞C`:"");
        return `<div class="flex items-center justify-between py-2 border-b border-gray-100">
          <div class="text-sm text-gray-700">${d.date||""} ‚Äî <span class="text-gray-600">${cond}</span></div>
          <div class="text-sm text-gray-700">${tmin} / ${tmax}</div>
        </div>`;
      }).join("");
      weatherDiv.innerHTML = rows;
    }

    function renderCity(list){
      if (!list.length){ cityDiv.textContent = "No recent updates."; return; }
      cityDiv.innerHTML = list.slice(0,8).map(x=>`
        <div class="text-sm py-1 border-b border-gray-100">
          <span class="text-gray-800">${x.type||"Update"}</span>
          <span class="text-gray-500">‚Äî ${x.detail||""}</span>
          ${x.address?`<span class="text-gray-400"> ‚Äî ${x.address}</span>`:""}
        </div>
      `).join("");
    }

    function makeMailto(rows, subject, body){
      const to = rows.flatMap(r => r.emails||[]).slice(0,5).join(",");
      return `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }

    // Simple modals
    const modalMap = {
      about:   document.getElementById("aboutModal"),
      founder: document.getElementById("founderModal"),
      contact: document.getElementById("contactModal"),
      feedback:document.getElementById("feedbackModal"),
    };
    $$('[data-open]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const k = btn.getAttribute("data-open");
        const m = modalMap[k];
        if (m) m.classList.add("open");
      });
    });
    $$('[data-close]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        btn.closest(".modal").classList.remove("open");
      });
    });
    Object.values(modalMap).forEach(m=>{
      m.addEventListener("click", (e)=>{ if(e.target===m) m.classList.remove("open"); });
    });

    // Feedback stars + fake store
    const stars = document.getElementById("stars");
    const starsNote = document.getElementById("starsNote");
    let fbScore = 0;
    stars?.addEventListener("click",(e)=>{
      const s = Number(e.target.getAttribute("data-s")||0);
      if (!s) return;
      fbScore = s;
      starsNote.textContent = `${s} / 5`;
    });
    document.getElementById("feedbackForm")?.addEventListener("submit",(e)=>{
      e.preventDefault();
      // Store locally just to show success (no server)
      localStorage.setItem("er_feedback", JSON.stringify({
        name: document.getElementById("fbName").value || "",
        email:document.getElementById("fbEmail").value||"",
        msg:  document.getElementById("fbMsg").value  ||"",
        stars: fbScore
      }));
      document.getElementById("fbThanks").classList.remove("hidden");
      setTimeout(()=> modalMap.feedback.classList.remove("open"), 900);
    });

    // PWA register
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      });
    }
    // PWA install prompt
    let deferredPrompt=null;
    const installBtn=document.getElementById("installBtn");
    window.addEventListener("beforeinstallprompt",(e)=>{
      e.preventDefault(); deferredPrompt=e;
      if (installBtn) installBtn.classList.remove("hidden");
    });
    installBtn?.addEventListener("click", async ()=>{
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      installBtn.classList.add("hidden");
      deferredPrompt=null;
    });
  </script>
</body>
</html>
