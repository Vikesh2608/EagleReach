<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EagleReach</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="p-6 text-center">
    <h1 class="text-4xl font-extrabold flex items-center justify-center space-x-2">
      <img alt="USA Flag" class="w-10 h-6 rounded-sm shadow" 
           src="https://upload.wikimedia.org/wikipedia/en/a/a4/Flag_of_the_United_States.svg" />
      <span>EagleReach</span>
    </h1>
    <p class="mt-2 text-gray-600">Enter your ZIP code to find local civic information and resources.</p>
  </header>

  <!-- Search -->
  <div class="flex justify-center mt-6 space-x-2">
    <input id="zipInput" type="text" placeholder="Enter ZIP code"
           class="border rounded-lg p-2 w-64" />
    <button id="searchBtn"
            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
      Search
    </button>
  </div>

  <!-- Info cards -->
  <main class="max-w-4xl mx-auto mt-10 grid grid-cols-1 md:grid-cols-2 gap-6 px-4">
    <!-- Election -->
    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-2">Upcoming Election</h2>
      <p><strong>Type</strong><br />General Election</p>
      <p><strong>Date</strong><br />November 4, 2025</p>
    </section>

    <!-- Officials -->
    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-2">Elected Representatives</h2>
      <button id="emailBtn"
              class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
        Generate Email
      </button>
      <ul id="officialsList" class="mt-4 space-y-2"></ul>
    </section>

    <!-- Minutes -->
    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-2">City Council Minutes</h2>
      <p>A new public park on Riverside Drive received final approval, and the city’s budget for the next fiscal year was passed, including investments in road safety and 311 responsiveness.</p>
      <button class="mt-3 bg-gray-800 text-white px-3 py-1 rounded">Summarized</button>
    </section>

    <!-- Report -->
    <section class="bg-white p-6 rounded-2xl shadow">
      <h2 class="text-xl font-bold mb-2">Report an Issue</h2>
      <p>You can report issues—potholes, outages, trash pickup—via your city’s 311 services.</p>
      <button class="mt-3 bg-blue-600 text-white px-3 py-1 rounded">Report</button>
    </section>
  </main>

  <!-- Fixed JavaScript -->
  <script>
    var BACKEND_BASE = "https://eaglereach-1.onrender.com";
    var zipInput  = document.getElementById("zipInput");
    var searchBtn = document.getElementById("searchBtn");
    var emailBtn  = document.getElementById("emailBtn");
    var listEl    = document.getElementById("officialsList");

    function isZip(v) {
      v = (v || "").trim();
      return /^\d{5}$/.test(v);
    }

    function escapeHtml(s) {
      return String(s || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function officialRow(o) {
      var office = o && o.office ? o.office : "Official";
      var name   = o && o.name ? o.name : "N/A";
      var site   = (o && o.urls && o.urls.length) ? o.urls[0] : null;

      var html = ''
        + '<li class="border border-gray-200 rounded-lg p-4">'
        +   '<p class="font-semibold">' + escapeHtml(name) + ' — '
        +     '<span class="text-gray-600">' + escapeHtml(office) + '</span>'
        +   '</p>';

      if (site) {
        var safeHref = site.indexOf('http') === 0 ? site : ('https://' + site);
        html += '<a class="text-blue-600 hover:underline break-all" href="'
             + escapeHtml(safeHref)
             + '" target="_blank" rel="noopener noreferrer">'
             + escapeHtml(safeHref.replace(/^https?:\/\/(www\.)?/i, ''))
             + '</a>';
      }

      html += '</li>';
      return html;
    }

    function setListLoading() {
      listEl.innerHTML = '<li class="text-gray-500">Loading…</li>';
    }
    function setListError(msg) {
      listEl.innerHTML = '<li class="text-red-600">Error: ' + escapeHtml(msg) + '</li>';
    }
    function setListEmpty() {
      listEl.innerHTML = '<li class="text-gray-500">No officials found.</li>';
    }

    function renderOfficials(officials) {
      if (!officials || !officials.length) {
        setListEmpty();
        return;
      }
      var html = '';
      for (var i = 0; i < officials.length; i++) {
        html += officialRow(officials[i]);
      }
      listEl.innerHTML = html;
    }

    async function onSearch() {
      var zip = (zipInput.value || "").trim();
      if (!isZip(zip)) {
        setListError("Please enter a valid 5-digit ZIP.");
        return;
      }
      setListLoading();
      try {
        var res = await fetch(BACKEND_BASE + "/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address: zip })
        });
        var data = await res.json();
        if (!res.ok) {
          throw new Error((data && data.detail) ? data.detail : "Lookup failed.");
        }
        renderOfficials(data.officials || []);
      } catch (err) {
        setListError(err && err.message ? err.message : "Lookup failed.");
      }
    }

    function generateEmail() {
      var zip = (zipInput.value || "").trim();
      var subject = encodeURIComponent("Constituent Inquiry");
      var body = encodeURIComponent(
        "Hello,\n\nI am a constituent in ZIP " + zip + " and would like to share my concerns...\n\nThank you,\n[Your Name]"
      );
      window.location.href = "mailto:?subject=" + subject + "&body=" + body;
    }

    if (searchBtn) searchBtn.addEventListener("click", onSearch);
    if (zipInput) {
      zipInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter") onSearch();
      });
    }
    if (emailBtn) emailBtn.addEventListener("click", generateEmail);

    if (zipInput) {
      zipInput.value = "62704";
    }
  </script>
</body>
</html>
