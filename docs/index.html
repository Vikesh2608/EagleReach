<script>
  // ===== Config =====
  const BACKEND_BASE = "https://eaglereach-1.onrender.com";

  // ===== DOM =====
  const zipInput  = document.getElementById("zipInput");
  const searchBtn = document.getElementById("searchBtn");
  const emailBtn  = document.getElementById("emailBtn");
  const listEl    = document.getElementById("officialsList");
  const recentWrap= document.getElementById("recentZips");
  const clearBtn  = document.getElementById("clearBtn");

  // ===== State =====
  let lastOfficials = [];
  const RECENT_KEY = "eaglereach_recent_zips";
  const RECENT_LIMIT = 6;

  // ===== Utils =====
  const isZip = v => /^\d{5}$/.test((v||"").trim());
  const escapeHtml = s => String(s||"")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  const prettyUrl = (u) => {
    try {
      const url = new URL(u.startsWith("http") ? u : "https://" + u);
      const host = url.hostname.replace(/^www\./, "");
      const path = url.pathname.replace(/\/$/, "");
      return path && path !== "/" ? host + path : host;
    } catch { return u; }
  };

  // ===== Recent ZIPs =====
  function loadRecents(){ try { return JSON.parse(localStorage.getItem(RECENT_KEY)||"[]"); } catch { return []; } }
  function saveRecent(zip){
    if (!isZip(zip)) return;
    const r = loadRecents().filter(z => z !== zip);
    r.unshift(zip); if (r.length > RECENT_LIMIT) r.length = RECENT_LIMIT;
    localStorage.setItem(RECENT_KEY, JSON.stringify(r));
    renderRecents();
  }
  function clearRecents(){
    localStorage.removeItem(RECENT_KEY);
    renderRecents();
  }
  function renderRecents(){
    if (!recentWrap) return;
    recentWrap.innerHTML = "";
    const r = loadRecents();
    r.forEach(zip => {
      const b = document.createElement("button");
      b.className = "px-3 py-1.5 rounded-lg border border-gray-300 bg-white hover:bg-gray-50 text-gray-700";
      b.textContent = zip;
      b.addEventListener("click", () => { zipInput.value = zip; run(); });
      recentWrap.appendChild(b);
    });
  }

  // ===== Rendering =====
  const setListLoading = (msg = "Loadingâ€¦") =>
    listEl.innerHTML = `<li class="text-gray-500">${escapeHtml(msg)}</li>`;
  const setListError   = msg =>
    listEl.innerHTML = `<li class="text-red-600">Error: ${escapeHtml(msg)}</li>`;
  const setListEmpty   = () =>
    listEl.innerHTML = '<li class="text-gray-500">No officials found.</li>';

  function officialRow(o){
    const office = o?.office || "Official";
    const name   = o?.name   || "N/A";
    const url    = (o?.urls && o.urls[0]) || "";
    const phone  = (o?.phones && o.phones[0]) || "";

    let html = `
      <li class="border border-gray-200 rounded-lg p-4 bg-white">
        <p class="font-semibold">${escapeHtml(name)} â€” <span class="text-gray-600">${escapeHtml(office)}</span></p>
    `;
    if (url) {
      const href = url.startsWith("http") ? url : `https://${url}`;
      html += `<a class="text-blue-600 hover:underline break-all block mt-1" href="${escapeHtml(href)}" target="_blank" rel="noopener noreferrer">${escapeHtml(prettyUrl(href))}</a>`;
    }
    if (phone) html += `<div class="text-gray-700 mt-1">ðŸ“ž ${escapeHtml(phone)}</div>`;
    html += `</li>`;
    return html;
  }

  function renderOfficials(list){
    if (!list || !list.length) { setListEmpty(); return; }
    listEl.innerHTML = list.map(officialRow).join("");
  }

  // ===== Fetch with timeout & robust errors =====
  async function askBackend(zip, timeoutMs = 15000){
    const ac = new AbortController();
    const t  = setTimeout(() => ac.abort(), timeoutMs);
    try {
      const r = await fetch(`${BACKEND_BASE}/ask`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: zip }),
        signal: ac.signal
      });

      const text = await r.text();
      let data; try { data = JSON.parse(text); }
      catch { throw new Error(`Bad JSON from API: ${text.slice(0,200)}â€¦`); }

      if (!r.ok) throw new Error(data?.detail || `HTTP ${r.status}`);
      return data;
    } finally {
      clearTimeout(t);
    }
  }

  // Warm up the Render app (no-cors so we don't need CORS headers)
  function warmBackend(){
    fetch(BACKEND_BASE + "/", { method: "GET", mode: "no-cors" }).catch(()=>{});
  }

  // ===== Run search with auto-retry for cold starts =====
  async function run(){
    const zip = (zipInput.value || "").trim();
    if (!isZip(zip)) { setListError("Please enter a valid 5-digit ZIP."); return; }

    setListLoading(); // initial loading

    try {
      // First attempt (15s)
      const data = await askBackend(zip, 15000);
      lastOfficials = data?.officials || [];
      renderOfficials(lastOfficials);
      saveRecent(zip);
      return;
    } catch (e) {
      console.warn("First attempt failed:", e);
      if (e.name === "AbortError" || /aborted|timed out/i.test(e.message || "")) {
        setListLoading("Waking the serverâ€¦ this can take up to a minute the first time. Retryingâ€¦");
        warmBackend();
        try {
          const data = await askBackend(zip, 60000);   // 60s retry
          lastOfficials = data?.officials || [];
          renderOfficials(lastOfficials);
          saveRecent(zip);
          return;
        } catch (e2) {
          console.error("Second attempt failed:", e2);
          setListError("Still timing out. Please click Search again in ~20 seconds.");
          return;
        }
      }
      setListError(e.message || "Lookup failed.");
    }
  }

  // ===== Email draft =====
  function salutationFor(o){
    const office = (o?.office || "").toLowerCase();
    if (office.includes("senator")) return "Senator";
    if (office.includes("representative")) return "Representative";
    return "Official";
  }
  function generateEmail(){
    const zip = (zipInput.value || "").trim();
    const names = (lastOfficials||[]).map(o => `${salutationFor(o)} ${o.name||""}`.trim()).filter(Boolean).join(", ");
    const linkLines = (lastOfficials||[]).map(o => {
      const url = (o?.urls && o.urls[0]) || "";
      const phone = (o?.phones && o.phones[0]) || "";
      const parts = [`- ${o?.name||"Unknown"} â€” ${o?.office||"Official"}`];
      if (url)   parts.push(url);
      if (phone) parts.push(`Phone: ${phone}`);
      return parts.join(" â€” ");
    }).join("\n");

    const subject = encodeURIComponent(`Constituent message from ZIP ${zip}`);
    const body = encodeURIComponent(
      `Dear ${names || "Representative"},\n\n` +
      `I am a constituent in ZIP ${zip}. I am writing regarding [your topic/issue].\n` +
      `[Add 2â€“3 sentences of context and a clear request here.]\n\n` +
      `Helpful links and contacts:\n${linkLines || "- (links will appear here after a lookup)"}\n\n` +
      `Thank you for your service.\n\n` +
      `[Your Name]\n[Street/Neighborhood, ${zip}]\n[Your contact info]`
    );
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }

  // ===== Wire-up =====
  if (searchBtn) searchBtn.addEventListener("click", run);
  if (zipInput)  zipInput.addEventListener("keydown", e => { if (e.key === "Enter") run(); });
  if (emailBtn)  emailBtn.addEventListener("click", generateEmail);
  if (clearBtn)  clearBtn.addEventListener("click", clearRecents);

  // Prefill & render, then warm
  if (zipInput && !zipInput.value) zipInput.value = "62704";
  renderRecents();
  warmBackend(); // start warming immediately
</script>
