<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EagleReach â€” Civic Assistant</title>
  <meta name="description" content="EagleReach: a free, open-source civic assistant for U.S. residents." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='52' x='6' font-size='56'%3EğŸ¦…%3C/text%3E%3C/svg%3E" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Subtle patriotic header */
    .hero {
      background: linear-gradient(120deg, #0a2540 0%, #123a60 60%, #192e4d 100%);
      position: relative;
      color: #fff;
    }
    .hero::after {
      content: "";
      position: absolute; inset: 0;
      background: radial-gradient(1200px 500px at 80% -50%, rgba(255,255,255,.10), transparent 60%),
                  radial-gradient(800px 400px at 10% -30%, rgba(255,255,255,.08), transparent 60%);
      pointer-events: none;
    }
    .card { @apply bg-white/90 backdrop-blur shadow rounded-2xl border border-slate-200; }
    .card h3 { @apply text-lg font-semibold text-slate-800; }
    .muted { @apply text-slate-500; }
    .btn { @apply inline-flex items-center justify-center gap-2 rounded-xl px-3 py-2 text-sm font-medium border border-slate-300 bg-white hover:bg-slate-50; }
    .btn-primary { @apply bg-blue-600 text-white border-blue-600 hover:bg-blue-700; }
    .link { @apply text-blue-700 hover:underline; }
    .kpi { @apply text-sm text-slate-600; }
    .pill { @apply inline-flex items-center gap-2 rounded-full px-3 py-1 text-xs font-medium border border-slate-300 bg-white; }
    @media (prefers-color-scheme: dark) {
      body { background: #0b1220; color: #e5e7eb; }
      .card { @apply bg-slate-900/60 text-slate-100 border-slate-700; }
      .card h3 { @apply text-slate-100; }
      .muted { @apply text-slate-400; }
      .btn { @apply bg-slate-800 border-slate-700 text-slate-100 hover:bg-slate-700; }
      .btn-primary { @apply bg-blue-600 border-blue-600 hover:bg-blue-700 text-white; }
      .link { @apply text-blue-400; }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="hero">
    <div class="max-w-6xl mx-auto px-4 py-6 relative">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-3xl">ğŸ¦…</span>
          <div>
            <h1 class="text-2xl sm:text-3xl font-bold tracking-tight">EagleReach</h1>
            <p class="text-sm text-slate-200">Openâ€‘source civic assistant for U.S. residents</p>
          </div>
        </div>
        <nav class="flex items-center gap-2">
          <button id="aboutBtn" class="btn">About</button>
          <a href="#contact" class="btn">Contact</a>
        </nav>
      </div>
      <div class="mt-6">
        <blockquote class="text-slate-200 italic max-w-3xl">
          â€œGovernment of the people, by the people, for the people, shall not perish from the Earth.â€
          <span class="not-italic">â€” Abraham Lincoln</span>
        </blockquote>
      </div>
    </div>
  </header>

  <!-- Search / Controls -->
  <section class="max-w-6xl mx-auto px-4 py-5">
    <div class="card p-4">
      <div class="flex flex-col lg:flex-row items-stretch gap-3">
        <input id="zipInput" type="text" inputmode="numeric" maxlength="10" placeholder="Enter ZIP (e.g., 62704)"
               class="w-full lg:w-72 rounded-xl border border-slate-300 px-4 py-2" />
        <div class="flex flex-wrap gap-2">
          <button id="locBtn" class="btn" title="Use my location">ğŸ“ Use my location</button>
          <button id="goBtn" class="btn-primary">Search</button>
          <button id="shareBtn" class="btn">ğŸ”— Copy share link</button>
          <button id="clearBtn" class="btn">ğŸ§¹ Clear history</button>
        </div>
      </div>
      <div id="history" class="mt-3 text-sm muted"></div>
      <div id="status" class="mt-2 text-sm"></div>
    </div>
  </section>

  <!-- Grid -->
  <main class="max-w-6xl mx-auto px-4 pb-12 grid grid-cols-1 lg:grid-cols-3 gap-5">
    <!-- Officials -->
    <section class="card p-4 lg:col-span-2">
      <div class="flex items-center justify-between">
        <h3>Elected Representatives</h3>
        <div class="flex gap-2">
          <button id="copyOfficialsBtn" class="pill">Copy Officials</button>
          <button id="genEmailBtn" class="pill">Generate Email</button>
        </div>
      </div>
      <div id="officialsMeta" class="kpi mt-1"></div>
      <div id="officialsList" class="mt-3 space-y-3"></div>
    </section>

    <!-- Weather -->
    <section class="card p-4">
      <h3 class="mb-2">Weather (7â€‘day)</h3>
      <div id="weatherList" class="space-y-2 text-sm"></div>
      <div id="weatherMeta" class="kpi mt-2"></div>
    </section>

    <!-- Roadworks -->
    <section class="card p-4 lg:col-span-1">
      <h3 class="mb-2">Roadworks near you</h3>
      <div id="roadList" class="space-y-2 text-sm"></div>
      <div id="roadMeta" class="kpi mt-2"></div>
    </section>

    <!-- City Updates -->
    <section class="card p-4 lg:col-span-2">
      <div class="flex items-center justify-between">
        <h3>City Updates <span class="muted text-xs font-normal">(beta)</span></h3>
        <span id="citySource" class="muted text-xs"></span>
      </div>
      <div id="cityList" class="mt-2 space-y-2 text-sm"></div>
    </section>

    <!-- Voter Info -->
    <section class="card p-4">
      <h3 class="mb-2">Voter Info & Education</h3>
      <div id="voterBlock" class="space-y-2 text-sm"></div>
    </section>

    <!-- Emergency & Help -->
    <section class="card p-4">
      <h3 class="mb-2">Emergency &amp; Help</h3>
      <ul class="text-sm space-y-1">
        <li>ğŸš¨ <a class="link" href="tel:911">Call 911</a></li>
        <li>ğŸ§  <a class="link" href="tel:988">988 Suicide & Crisis Lifeline</a></li>
        <li>â˜£ï¸ <a class="link" href="tel:18002221222">Poison Control (1â€‘800â€‘222â€‘1222)</a></li>
        <li>ğŸ¤ <a class="link" href="tel:211">211 Community Services</a></li>
        <li>ğŸ‘® Nonâ€‘emergency police (search): <span id="nonEmergencyLink"></span></li>
        <li>ğŸ› ï¸ City 311 online (search): <span id="sr311Link"></span></li>
      </ul>
    </section>
  </main>

  <!-- About Modal -->
  <dialog id="aboutDlg" class="rounded-2xl p-0 w-[min(800px,92vw)]">
    <div class="p-5 card !bg-white dark:!bg-slate-900">
      <div class="flex items-start justify-between">
        <h3 class="text-xl font-bold">About</h3>
        <button id="aboutClose" class="btn">Close</button>
      </div>
      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h4 class="font-semibold">About EagleReach</h4>
          <p class="mt-2 text-sm">
            EagleReach is a public, openâ€‘source civic assistant that connects U.S. residents with
            elected officials, weather forecasts, traffic/roadworks, city service updates (where available),
            and voter information â€” all by ZIP code. The goal is to make civic access fast, trustworthy,
            and free for everyone.
          </p>
          <blockquote class="mt-3 text-sm italic">
            â€œGovernment of the people, by the people, for the people, shall not perish from the Earth.â€
            <span class="not-italic">â€” Abraham Lincoln</span>
          </blockquote>
        </div>
        <div>
          <h4 class="font-semibold">About the Founder</h4>
          <p class="mt-2 text-sm">
            <strong>Vikesh Sagar Bairam â€” Founder of EagleReach Â· AI/ML &amp; Generative AI Engineer Â· Data Engineer Â· DevOps Specialist Â· Research Professional</strong>
          </p>
          <p class="text-sm mt-2">
            <strong>Education:</strong> Masterâ€™s in Information Systems &amp; Management (University of Illinois, Springfield);
            Bachelorâ€™s in Psychology; Bachelorâ€™s in Computer Science.
          </p>
          <p class="text-sm mt-1">
            <strong>Experience:</strong> Currently at Jabil; previously at Surfaces by Pacific.
          </p>
          <p class="text-sm mt-2">
            <strong>Contact:</strong>
            <a class="link" href="mailto:vikebairam@gmail.com">vikebairam@gmail.com</a> Â·
            <a class="link" href="https://www.linkedin.com/in/vikesh-bairam-219769258/" target="_blank">LinkedIn</a> Â·
            <a class="link" href="https://github.com/Vikesh2608" target="_blank">GitHub</a>
          </p>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Contact anchor -->
  <footer id="contact" class="border-t border-slate-200 dark:border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-8 text-sm">
      <div>
        <strong>Contact:</strong>
        <a class="link" href="mailto:vikebairam@gmail.com">vikebairam@gmail.com</a> Â·
        <a class="link" href="https://www.linkedin.com/in/vikesh-bairam-219769258/" target="_blank">LinkedIn</a> Â·
        <a class="link" href="https://github.com/Vikesh2608" target="_blank">GitHub</a>
      </div>
      <div class="mt-2 muted">Â© <span id="year"></span> EagleReach. Built openâ€‘source.</div>
    </div>
  </footer>

  <!-- App Script -->
  <script>
    const BACKEND_BASE = "https://eaglereach-1.onrender.com"; // <-- ensure this matches your Render URL

    // ---------- Utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function telHref(raw) { return `tel:${(raw||'').replace(/[^\d+]/g,'')}`; }
    function prettyPhone(raw) {
      if (!raw) return "";
      const d = raw.replace(/[^\d]/g,'');
      if (d.length === 10) return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
      return raw;
    }
    async function fetchJSON(url) {
      const r = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return await r.json();
    }
    function setStatus(msg, kind="info"){
      const el = $("#status");
      el.textContent = msg || "";
      el.className = "mt-2 text-sm " + (kind==="error" ? "text-red-600" : "muted");
    }
    function qsParam(name, value){
      const url = new URL(location.href);
      url.searchParams.set(name, value);
      history.replaceState({}, "", url.toString());
    }

    // ---------- History ----------
    const HISTORY_KEY = "eaglereach_zip_history";
    function loadHistory(){
      try { return JSON.parse(localStorage.getItem(HISTORY_KEY)||"[]"); } catch { return []; }
    }
    function saveHistory(z){
      if (!z) return;
      const arr = loadHistory().filter(x => x !== z);
      arr.unshift(z);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,5)));
      renderHistory();
    }
    function renderHistory(){
      const arr = loadHistory();
      if (!arr.length) { $("#history").textContent = ""; return; }
      $("#history").innerHTML = "Recent ZIPs: " + arr.map(z => 
        `<button class="pill mr-1 my-1" onclick="useZip('${z}')">${z}</button>`
      ).join(" ");
    }
    window.useZip = (z) => { $("#zipInput").value = z; run(); };

    // ---------- Geolocation â†’ ZIP ----------
    async function locateMe(){
      try{
        setStatus("Locatingâ€¦");
        const pos = await new Promise((res, rej) =>
          navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true, timeout: 12000 })
        );
        const { latitude: lat, longitude: lon } = pos.coords;
        // Reverse geocode (no key)
        const rg = await fetchJSON(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
        const zip = rg.postcode || rg.localityInfo?.administrative?.find(x=>/postcode/i.test(x.description))?.name;
        if (!zip) throw new Error("ZIP not found for your location");
        $("#zipInput").value = zip;
        setStatus(`Using detected ZIP ${zip}`);
        run();
      }catch(e){
        console.error(e);
        setStatus(`Could not get your location: ${e.message}`, "error");
      }
    }

    // ---------- Rendering ----------
    function renderOfficials(data){
      const list = $("#officialsList");
      $("#officialsMeta").textContent = data.place ? `${data.place}, ${data.state?.abbr || ""} â€¢ CD: ${data.district || "N/A"} â€¢ Updated ${new Date(data.generated_at).toLocaleString()}` : "";
      list.innerHTML = "";
      (data.officials || []).forEach(o => {
        const phones = (o.phones||[]).map(p => `<a class="link" href="${telHref(p)}">${prettyPhone(p)}</a>`).join(" Â· ");
        const urls   = (o.urls||[]).slice(0,1).map(u => `<a class="link" href="${u}" target="_blank">Official Site</a>`).join("");
        const party  = o.party ? ` Â· ${o.party}` : "";
        const row = document.createElement("div");
        row.className = "p-3 rounded-xl border border-slate-200 dark:border-slate-700";
        row.innerHTML = `
          <div class="font-semibold">${o.name}</div>
          <div class="text-sm muted">${o.office}${party}</div>
          <div class="text-sm mt-1">${phones || ""} ${urls ? " Â· "+urls : ""}</div>
        `;
        list.appendChild(row);
      });
    }

    function renderWeather(data){
      const wrap = $("#weatherList");
      const meta = $("#weatherMeta");
      wrap.innerHTML = "";
      (data.days || []).forEach(d => {
        const el = document.createElement("div");
        el.className = "flex items-center justify-between border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2";
        el.innerHTML = `
          <div class="text-sm">${d.date}</div>
          <div class="text-sm">${Math.round(d.tmin_c)}Â° / ${Math.round(d.tmax_c)}Â°C</div>
          <div class="text-xs muted">Precip: ${d.precip_pct ?? "â€”"}%</div>
        `;
        wrap.appendChild(el);
      });
      meta.textContent = data.updated_at ? `Updated ${new Date(data.updated_at).toLocaleString()} â€¢ Source: ${data.source}` : "";
    }

    function renderRoadworks(data){
      const wrap = $("#roadList");
      const meta = $("#roadMeta");
      wrap.innerHTML = "";
      (data.items || []).slice(0,8).forEach(it => {
        const map = it.lat && it.lon ? ` Â· <a class="link" href="https://maps.google.com/?q=${it.lat},${it.lon}" target="_blank">Map</a>` : "";
        const el = document.createElement("div");
        el.className = "border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2";
        el.innerHTML = `<div class="text-sm"><strong>${it.name}</strong> ${it.kind ? `Â· ${it.kind}`:""} ${it.distance_km!=null?`Â· ${it.distance_km} km`: ""} ${map}</div>`;
        wrap.appendChild(el);
      });
      meta.textContent = `Source: ${data.source || "Open data"}`;
    }

    function renderCityUpdates(data){
      const list = $("#cityList");
      const src  = $("#citySource");
      list.innerHTML = "";
      if ((data.items||[]).length === 0){
        list.innerHTML = `<div class="muted">City feed not available yet for this location. Try your cityâ€™s notices: 
          <a class="link" target="_blank" href="https://www.google.com/search?q=site:.gov+${encodeURIComponent(current.place||'')+ '%20' + encodeURIComponent(current.state||'') }+roadwork+OR+notices+OR+construction">Search</a>.
        </div>`;
      } else {
        (data.items||[]).slice(0,8).forEach(i => {
          const el = document.createElement("div");
          el.className = "border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-2";
          el.innerHTML = `<div><strong>${i.type || "Update"}</strong> â€” ${i.detail || i.status || ""}</div>
                          <div class="text-xs muted">${i.address || ""} ${i.created ? "Â· " + new Date(i.created).toLocaleString() : ""}</div>`;
          list.appendChild(el);
        });
      }
      src.textContent = data.source || data.note || "";
    }

    function renderVoter(data){
      const b = $("#voterBlock");
      const st = data.state?.name || "";
      const links = data.links || {};
      b.innerHTML = `
        <div>State: <strong>${st}</strong></div>
        <div class="flex flex-col gap-2 mt-2">
          <a class="btn" target="_blank" href="${links.register}">ğŸ“ Register to Vote (Vote.gov)</a>
          <a class="btn" target="_blank" href="${links.state_office}">ğŸ›ï¸ Your State Election Office</a>
          <a class="btn" target="_blank" href="${links.how_to_vote}">ğŸ“˜ How to Vote / Rules</a>
          <a class="btn" target="_blank" href="${links.county_directory}">ğŸ“‡ County Election Contacts</a>
        </div>
      `;
    }

    function updateEmergencyLinks(place, state){
      const city = encodeURIComponent(place || "");
      const st = encodeURIComponent(state || "");
      $("#nonEmergencyLink").innerHTML = `<a class="link" target="_blank" href="https://www.google.com/search?q=non+emergency+police+${city}+${st}+phone">Find number</a>`;
      $("#sr311Link").innerHTML = `<a class="link" target="_blank" href="https://www.google.com/search?q=report+311+issue+${city}+${st}">Open 311</a>`;
    }

    // ---------- Main flow ----------
    let current = { zip: "", place: "", state: "" };

    async function run(){
      const zip = ($("#zipInput").value || "").trim();
      if (!zip) { setStatus("Enter a ZIP to search."); return; }
      setStatus("Loadingâ€¦");
      qsParam("zip", zip);
      saveHistory(zip);

      try{
        // Officials
        const officials = await fetchJSON(`${BACKEND_BASE}/officials?zip=${encodeURIComponent(zip)}`);
        current = { zip, place: officials.place, state: officials.state?.abbr };
        renderOfficials(officials);
        updateEmergencyLinks(officials.place, officials.state?.abbr);

        // Weather
        try { renderWeather(await fetchJSON(`${BACKEND_BASE}/weather?zip=${zip}`)); } catch(e){ console.warn(e); }

        // Roadworks
        try { renderRoadworks(await fetchJSON(`${BACKEND_BASE}/roadworks?zip=${zip}`)); } catch(e){ console.warn(e); }

        // City Updates
        try { renderCityUpdates(await fetchJSON(`${BACKEND_BASE}/city/updates?zip=${zip}`)); } catch(e){ console.warn(e); }

        // Voter info
        try { renderVoter(await fetchJSON(`${BACKEND_BASE}/voter?zip=${zip}`)); } catch(e){ console.warn(e); }

        setStatus(`Loaded for ${officials.place}, ${officials.state?.abbr || ""}`);
      }catch(e){
        console.error(e);
        setStatus(`Fetch error: ${e.message}`, "error");
      }
    }

    // ---------- Email generation ----------
    $("#genEmailBtn").addEventListener("click", () => {
      const list = Array.from($("#officialsList").children);
      let email = "";
      for (const item of list){
        const link = item.querySelector("a[href^='mailto:']");
        if (link){ email = link.href.replace("mailto:",""); break; }
      }
      // If we don't have official email, build a generic subject/body for copy
      const subj = encodeURIComponent(`Community concern from ZIP ${current.zip}`);
      const body = encodeURIComponent(
`Hello,

I am a resident in ZIP ${current.zip} (${current.place}, ${current.state}). Iâ€™d like to report a local concern:

â€¢ Issue type: [Pothole / Trash / Street light out / Noise / Parking / Other]
â€¢ Location / nearest address:
â€¢ Brief description:

Thank you for your attention.

Sincerely,
[Your Name]`
      );
      const href = `mailto:${email}?subject=${subj}&body=${body}`;
      location.href = href;
    });

    // ---------- Copy officials (names + offices) ----------
    $("#copyOfficialsBtn").addEventListener("click", async () => {
      const blocks = Array.from($("#officialsList").children).map(div => div.innerText.trim()).join("\n\n");
      try { await navigator.clipboard.writeText(blocks); setStatus("Officials copied to clipboard."); }
      catch { setStatus("Copy failed. Select text and copy manually.", "error"); }
    });

    // ---------- Controls ----------
    $("#goBtn").addEventListener("click", run);
    $("#zipInput").addEventListener("keydown", e => { if (e.key === "Enter") run(); });
    $("#locBtn").addEventListener("click", locateMe);
    $("#shareBtn").addEventListener("click", async () => {
      try { await navigator.clipboard.writeText(location.href); setStatus("Share link copied."); }
      catch { setStatus("Copy failed â€” copy URL manually.", "error"); }
    });
    $("#clearBtn").addEventListener("click", () => { localStorage.removeItem(HISTORY_KEY); renderHistory(); setStatus("History cleared."); });

    // About dialog
    const dlg = $("#aboutDlg");
    $("#aboutBtn").addEventListener("click", () => dlg.showModal());
    $("#aboutClose").addEventListener("click", () => dlg.close());

    // Init
    $("#year").textContent = new Date().getFullYear();
    renderHistory();

    // Load initial ZIP from URL if present
    const urlZip = new URL(location.href).searchParams.get("zip");
    if (urlZip) { $("#zipInput").value = urlZip; run(); }
  </script>
</body>
</html>
