<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EagleReach</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>EagleReach</h1>
  <p id="subtitle">Enter your ZIP code to find local civic information and resources.</p>

  <!-- Search controls -->
  <div id="controls">
    <input id="zipInput" type="text" inputmode="numeric" maxlength="5" placeholder="ZIP code (e.g., 62704)" />
    <button id="searchBtn" type="button">Search</button>
    <button id="clearBtn" type="button" title="Clear recent ZIP history">Clear History</button>
  </div>

  <!-- Recent ZIP chips -->
  <div id="recent">
    <div class="label">Recent</div>
    <div id="recentZips"></div>
  </div>

  <!-- Cards -->
  <div id="cards">
    <div class="card">
      <h2>Upcoming Election</h2>
      <p><strong>Type</strong><br />General Election</p>
      <p><strong>Date</strong><br />November 4, 2025</p>
    </div>

    <div class="card">
      <h2>Elected Representatives</h2>
      <ul id="officialsList"></ul>
      <button id="emailBtn" type="button">Generate Email</button>
    </div>

    <div class="card">
      <h2>City Council Minutes</h2>
      <p>
        A new public park on Riverside Drive received final approval, and the city's budget for the next
        fiscal year was passed, including investments in road safety and 311 responsiveness.
      </p>
    </div>

    <div class="card">
      <h2>Report an Issue</h2>
      <p>You can report issuesâ€”potholes, outages, trash pickupâ€”via your cityâ€™s 311 services.</p>
    </div>
  </div>

  <p id="footer-note">Built for civic engagement. Data via Congress Legislators + Census.</p>

  <script>
    // ===== Config =====
    const BACKEND_BASE = "https://eaglereach-1.onrender.com";

    // ===== DOM =====
    const zipInput   = document.getElementById("zipInput");
    const searchBtn  = document.getElementById("searchBtn");
    const emailBtn   = document.getElementById("emailBtn");
    const listEl     = document.getElementById("officialsList");
    const recentWrap = document.getElementById("recentZips");
    const clearBtn   = document.getElementById("clearBtn");

    // ===== State =====
    let lastOfficials = [];
    const RECENT_KEY   = "eaglereach_recent_zips";
    const RECENT_LIMIT = 6;

    // ===== Utils =====
    const isZip = v => /^\d{5}$/.test((v || "").trim());
    const esc = s => String(s || "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");

    const prettyUrl = (u) => {
      try {
        const url = new URL(u.startsWith("http") ? u : "https://" + u);
        const host = url.hostname.replace(/^www\./, "");
        const path = url.pathname.replace(/\/$/, "");
        return path && path !== "/" ? host + path : host;
      } catch { return u; }
    };

    // ===== Recent ZIPs =====
    function loadRecents() {
      try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); }
      catch { return []; }
    }
    function saveRecent(zip) {
      if (!isZip(zip)) return;
      const r = loadRecents().filter(z => z !== zip);
      r.unshift(zip);
      if (r.length > RECENT_LIMIT) r.length = RECENT_LIMIT;
      localStorage.setItem(RECENT_KEY, JSON.stringify(r));
      renderRecents();
    }
    function clearRecents() {
      localStorage.removeItem(RECENT_KEY);
      renderRecents();
    }
    function renderRecents() {
      recentWrap.innerHTML = "";
      const r = loadRecents();
      r.forEach(zip => {
        const b = document.createElement("button");
        b.className = "chip";
        b.textContent = zip;
        b.addEventListener("click", () => { zipInput.value = zip; run(); });
        recentWrap.appendChild(b);
      });
    }

    // ===== Rendering =====
    const setListLoading = (msg = "Loadingâ€¦") => {
      listEl.innerHTML = `<li class="muted">${esc(msg)}</li>`;
    };
    const setListError = (msg) => {
      listEl.innerHTML = `<li class="error">Error: ${esc(msg)}</li>`;
    };
    const setListEmpty = () => {
      listEl.innerHTML = `<li class="muted">No officials found.</li>`;
    };

    function officialRow(o) {
      const office = o?.office || "Official";
      const name   = o?.name || "N/A";
      const url    = (o?.urls && o.urls[0]) || "";
      const phone  = (o?.phones && o.phones[0]) || "";

      let html = `<li class="official">
        <div class="name">${esc(name)} â€” <span class="office">${esc(office)}</span></div>`;
      if (url) {
        const href = url.startsWith("http") ? url : `https://${url}`;
        html += `<a class="site" href="${esc(href)}" target="_blank" rel="noopener noreferrer">${esc(prettyUrl(href))}</a>`;
      }
      if (phone) {
        html += `<div class="phone">ðŸ“ž ${esc(phone)}</div>`;
      }
      html += `</li>`;
      return html;
    }

    function renderOfficials(list) {
      if (!list || !list.length) { setListEmpty(); return; }
      listEl.innerHTML = list.map(officialRow).join("");
    }

    // ===== Fetch with timeout & robust errors =====
    async function askBackend(zip, timeoutMs = 15000) {
      const ac = new AbortController();
      const timer = setTimeout(() => ac.abort(), timeoutMs);
      try {
        const r = await fetch(`${BACKEND_BASE}/ask`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ address: zip }),
          signal: ac.signal
        });
        const text = await r.text();
        let data;
        try { data = JSON.parse(text); }
        catch { throw new Error(`Bad JSON from API: ${text.slice(0,200)}â€¦`); }
        if (!r.ok) throw new Error(data?.detail || `HTTP ${r.status}`);
        return data;
      } finally {
        clearTimeout(timer);
      }
    }

    // Wakes the Render app (noâ€‘cors so it never blocks UI)
    function warmBackend() {
      fetch(BACKEND_BASE + "/", { method: "GET", mode: "no-cors" }).catch(()=>{});
    }

    // ===== Run search with autoâ€‘retry for cold starts =====
    async function run() {
      const zip = (zipInput.value || "").trim();
      if (!isZip(zip)) { setListError("Please enter a valid 5-digit ZIP."); return; }

      setListLoading("Loadingâ€¦");
      try {
        // first try (15s)
        const data = await askBackend(zip, 15000);
        lastOfficials = data?.officials || [];
        renderOfficials(lastOfficials);
        saveRecent(zip);
        return;
      } catch (e) {
        console.warn("First attempt failed:", e);
        if (e.name === "AbortError" || /aborted|timed out/i.test(e.message || "")) {
          setListLoading("Waking the serverâ€¦ this can take up to a minute the first time. Retryingâ€¦");
          warmBackend();
          try {
            const data = await askBackend(zip, 60000); // retry up to 60s
            lastOfficials = data?.officials || [];
            renderOfficials(lastOfficials);
            saveRecent(zip);
            return;
          } catch (e2) {
            console.error("Second attempt failed:", e2);
            setListError("Still timing out. Please click Search again in ~20 seconds.");
            return;
          }
        }
        setListError(e.message || "Lookup failed.");
      }
    }

    // ===== Email draft =====
    function salutationFor(o) {
      const office = (o?.office || "").toLowerCase();
      if (office.includes("senator")) return "Senator";
      if (office.includes("representative")) return "Representative";
      return "Official";
    }
    function generateEmail() {
      const zip = (zipInput.value || "").trim();
      const names = (lastOfficials || [])
        .map(o => `${salutationFor(o)} ${o.name || ""}`.trim())
        .filter(Boolean)
        .join(", ");

      const linkLines = (lastOfficials || []).map(o => {
        const url   = (o?.urls && o.urls[0]) || "";
        const phone = (o?.phones && o.phones[0]) || "";
        const parts = [`- ${o?.name || "Unknown"} â€” ${o?.office || "Official"}`];
        if (url)   parts.push(url);
        if (phone) parts.push(`Phone: ${phone}`);
        return parts.join(" â€” ");
      }).join("\n");

      const subject = encodeURIComponent(`Constituent message from ZIP ${zip}`);
      const body = encodeURIComponent(
        `Dear ${names || "Representative"},\n\n` +
        `I am a constituent in ZIP ${zip}. I am writing regarding [your topic/issue].\n` +
        `[Add 2â€“3 sentences of context and a clear request here.]\n\n` +
        `Helpful links and contacts:\n${linkLines || "- (links will appear here after a lookup)"}\n\n` +
        `Thank you for your service.\n\n` +
        `[Your Name]\n[Street/Neighborhood, ${zip}]\n[Your contact info]`
      );
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
    }

    // ===== Wireâ€‘up =====
    if (searchBtn) searchBtn.addEventListener("click", run);
    if (zipInput)  zipInput.addEventListener("keydown", e => { if (e.key === "Enter") run(); });
    if (emailBtn)  emailBtn.addEventListener("click", generateEmail);
    if (clearBtn)  clearBtn.addEventListener("click", clearRecents);

    // Prefill, render, warm
    if (zipInput && !zipInput.value) zipInput.value = "62704";
    renderRecents();
    warmBackend();
  </script>
</body>
</html>

