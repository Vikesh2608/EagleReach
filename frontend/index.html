<script>
  // ===== Config =====
  var BACKEND_BASE = "https://eaglereach-1.onrender.com";

  // ===== DOM =====
  var zipInput   = document.getElementById("zipInput");
  var searchBtn  = document.getElementById("searchBtn");
  var emailBtn   = document.getElementById("emailBtn");
  var listEl     = document.getElementById("officialsList");
  var recentWrap = document.getElementById("recentZips"); // optional, shown if present

  // ===== State =====
  var lastOfficials = [];              // snapshot from last successful lookup
  var RECENT_KEY    = "eaglereach_recent_zips";
  var RECENT_LIMIT  = 6;

  // ===== Utils =====
  function isZip(v) {
    v = (v || "").trim();
    return /^\d{5}$/.test(v);
  }

  function escapeHtml(s) {
    return String(s || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  function fmtPrettyUrl(u) {
    try {
      var url = new URL(u.startsWith("http") ? u : "https://" + u);
      var host = url.hostname.replace(/^www\./, "");
      var path = url.pathname.replace(/\/$/, "");
      return path && path !== "/" ? (host + path) : host;
    } catch (e) {
      return u;
    }
  }

  // ===== Recent ZIPs =====
  function loadRecents() {
    try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); }
    catch (e) { return []; }
  }
  function saveRecent(zip) {
    if (!isZip(zip)) return;
    var r = loadRecents().filter(function (z) { return z !== zip; });
    r.unshift(zip);
    if (r.length > RECENT_LIMIT) r.length = RECENT_LIMIT;
    localStorage.setItem(RECENT_KEY, JSON.stringify(r));
    renderRecents();
  }
  function renderRecents() {
    if (!recentWrap) return;
    var r = loadRecents();
    recentWrap.innerHTML = "";
    if (!r.length) return;
    r.forEach(function (zip) {
      var b = document.createElement("button");
      b.className =
        "inline-flex items-center px-3 py-1.5 rounded-lg border border-gray-300 " +
        "text-gray-700 bg-white hover:bg-gray-50 transition";
      b.textContent = zip;
      b.addEventListener("click", function () {
        zipInput.value = zip;
        onSearch();
      });
      recentWrap.appendChild(b);
    });
  }

  // ===== Rendering =====
  function setListLoading() {
    listEl.innerHTML = '<li class="text-gray-500">Loadingâ€¦</li>';
  }
  function setListError(msg) {
    listEl.innerHTML = '<li class="text-red-600">Error: ' + escapeHtml(msg) + "</li>";
  }
  function setListEmpty() {
    listEl.innerHTML = '<li class="text-gray-500">No officials found.</li>';
  }

  function officialRow(o) {
    var office = o && o.office ? o.office : "Official";
    var name   = o && o.name ? o.name : "N/A";
    var site   = (o && o.urls && o.urls.length) ? o.urls[0] : "";
    var phone  = (o && o.phones && o.phones.length) ? o.phones[0] : "";

    var html = ''
      + '<li class="border border-gray-200 rounded-lg p-4 bg-white">'
      +   '<p class="font-semibold">' + escapeHtml(name) + ' â€” '
      +     '<span class="text-gray-600">' + escapeHtml(office) + '</span>'
      +   '</p>';

    if (site) {
      var safeHref = site.indexOf("http") === 0 ? site : ("https://" + site);
      html += '<a class="text-blue-600 hover:underline break-all block mt-1" href="'
           + escapeHtml(safeHref) + '" target="_blank" rel="noopener noreferrer">'
           + escapeHtml(fmtPrettyUrl(safeHref)) + '</a>';
    }
    if (phone) {
      html += '<div class="text-gray-700 mt-1">ðŸ“ž ' + escapeHtml(phone) + "</div>";
    }

    html += "</li>";
    return html;
  }

  function renderOfficials(officials) {
    if (!officials || !officials.length) {
      setListEmpty();
      return;
    }
    var html = "";
    for (var i = 0; i < officials.length; i++) html += officialRow(officials[i]);
    listEl.innerHTML = html;
  }

  // ===== Fetch & Search =====
  async function onSearch() {
    var zip = (zipInput.value || "").trim();
    if (!isZip(zip)) {
      setListError("Please enter a valid 5-digit ZIP.");
      return;
    }
    setListLoading();
    try {
      var res = await fetch(BACKEND_BASE + "/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ address: zip })
      });
      var data = await res.json();
      if (!res.ok) {
        throw new Error((data && data.detail) ? data.detail : "Lookup failed.");
      }
      lastOfficials = data.officials || [];
      renderOfficials(lastOfficials);
      saveRecent(zip);
    } catch (err) {
      setListError(err && err.message ? err.message : "Lookup failed.");
    }
  }

  // ===== Email Draft =====
  function salutationFor(o) {
    var office = (o && o.office || "").toLowerCase();
    if (office.indexOf("senator") >= 0) return "Senator";
    if (office.indexOf("representative") >= 0) return "Representative";
    return "Official";
  }

  function generateEmail() {
    var zip = (zipInput.value || "").trim();
    var names = (lastOfficials || [])
      .map(function (o) { return salutationFor(o) + " " + (o.name || ""); })
      .filter(Boolean)
      .join(", ");

    var linkLines = (lastOfficials || []).map(function (o) {
      var url = (o.urls && o.urls[0]) ? o.urls[0] : "";
      var phone = (o.phones && o.phones[0]) ? o.phones[0] : "";
      var parts = ["- " + (o.name || "Unknown") + " â€” " + (o.office || "Official")];
      if (url)   parts.push(url);
      if (phone) parts.push("Phone: " + phone);
      return parts.join(" â€” ");
    }).join("\n");

    var subject = encodeURIComponent("Constituent message from ZIP " + zip);
    var body = encodeURIComponent(
      "Dear " + (names || "Representative") + ",\n\n" +
      "I am a constituent in ZIP " + zip + ". I am writing regarding [your topic/issue].\n" +
      "[Add 2â€“3 sentences of context and a clear request here.]\n\n" +
      "Helpful links and contacts:\n" +
      (linkLines || "- (contact links to your offices will appear here after a lookup)") + "\n\n" +
      "Thank you for your service.\n\n" +
      "[Your Name]\n" +
      "[Street/Neighborhood, " + zip + "]\n" +
      "[Your contact info]"
    );

    // Open the user's email client with subject + body prefilled.
    window.location.href = "mailto:?subject=" + subject + "&body=" + body;
  }

  // ===== Wire-up =====
  if (searchBtn) searchBtn.addEventListener("click", onSearch);
  if (zipInput) {
    zipInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") onSearch();
    });
  }
  if (emailBtn) emailBtn.addEventListener("click", generateEmail);

  // Prefill + populate recents
  if (zipInput && !zipInput.value) zipInput.value = "62704";
  renderRecents();
  // Optionally auto-run: onSearch();
</script>
